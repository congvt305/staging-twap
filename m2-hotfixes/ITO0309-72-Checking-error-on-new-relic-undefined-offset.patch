From c12c214b2058da3f3dac6a82a3f7e5580f09ec72 Mon Sep 17 00:00:00 2001
From: Hoang Phan <hoangphan@amorepacific.com>
Date: Wed, 15 Feb 2023 13:59:11 +0700
Subject: [PATCH] ITO0309-72 [G-DEV] Checking error on new
 relic_report.CRITICAL: Notice: Undifined offset

---
 vendor/magento/framework/Filter/DirectiveProcessor/DependDirective.php | 31 +++++++++++++++++--
 vendor/magento/framework/Filter/Template.php                           |  9 ++++++
 2 files changed, 38 insertions(+), 2 deletions(-)

diff --git a/vendor/magento/framework/Filter/DirectiveProcessor/DependDirective.php b/vendor/magento/framework/Filter/DirectiveProcessor/DependDirective.php
index 83345ac..92d36ca 100644
--- a/vendor/magento/framework/Filter/DirectiveProcessor/DependDirective.php
+++ b/vendor/magento/framework/Filter/DirectiveProcessor/DependDirective.php
@@ -8,6 +8,7 @@ declare(strict_types=1);

 namespace Magento\Framework\Filter\DirectiveProcessor;

+use Magento\Framework\App\RequestInterface;
 use Magento\Framework\Filter\DirectiveProcessorInterface;
 use Magento\Framework\Filter\Template;
 use Magento\Framework\Filter\VariableResolverInterface;
@@ -22,13 +23,20 @@ class DependDirective implements DirectiveProcessorInterface
      */
     private $variableResolver;

+    /**
+     * @var RequestInterface
+     */
+    protected $_request;
+
     /**
      * @param VariableResolverInterface $variableResolver
      */
     public function __construct(
-        VariableResolverInterface $variableResolver
+        VariableResolverInterface $variableResolver,
+        RequestInterface $request
     ) {
         $this->variableResolver = $variableResolver;
+        $this->_request = $request;
     }

     /**
@@ -44,7 +52,26 @@ class DependDirective implements DirectiveProcessorInterface
             // If template processing
             return $construction[0];
         }
-
+        // ADD LOG
+        if (!isset($construction[1])) {
+            $writer = new \Zend_Log_Writer_Stream(BP . '/var/log/log-for-ticket-ITO0309-72-G-DEV.log');
+            $logger = new \Zend_Log();
+            $logger->addWriter($writer);
+            $errorMsg = 'Notice: Undefined offset: 1 in vendor/magento/framework/Filter/DirectiveProcessor/DependDirective.php on line 48: ';
+            $debugBackTrace = debug_backtrace(DEBUG_BACKTRACE_IGNORE_ARGS);
+            $backTrace = '';
+            foreach ($debugBackTrace as $item) {
+                $backTrace .= @$item['class'] . ':' . @$item['line'] . @$item['type'] . @$item['function'] . " | ";
+            }
+            $logger->crit($errorMsg . $backTrace);
+            $logger->info('full action name: ' . $this->_request->getFullActionName());
+            $logger->info('user agent: ' . $_SERVER['HTTP_USER_AGENT'] ?? 'cannot get user agent');
+            $logger->info('request uri: ' . $_SERVER['REQUEST_URI'] ?? 'cannot get request uri');
+            $logger->info('mage run code: ' . $_SERVER['MAGE_RUN_CODE'] ?? 'cannot get mage_run_code');
+            $logger->info('construction data: ' . json_encode($construction));
+            $logger->info('template variables: ' . json_encode($templateVariables));
+            return '';
+        }
         if ($this->variableResolver->resolve($construction[1], $filter, $templateVariables) == '') {
             return '';
         } else {
diff --git a/vendor/magento/framework/Filter/Template.php b/vendor/magento/framework/Filter/Template.php
index be4c7eb..8b9d156 100644
--- a/vendor/magento/framework/Filter/Template.php
+++ b/vendor/magento/framework/Filter/Template.php
@@ -181,6 +181,15 @@ class Template implements \Zend_Filter_Interface

             if (preg_match_all($directiveProcessor->getRegularExpression(), $value, $constructions, PREG_SET_ORDER)) {
                 foreach ($constructions as $construction) {
+                    if (is_array($construction) && empty($construction)) {
+                        $writer = new \Zend_Log_Writer_Stream(BP . '/var/log/log-for-ticket-ITO0309-72-G-DEV.log');
+                        $logger = new \Zend_Log();
+                        $logger->addWriter($writer);
+                        $logger->info('-- inside function \Magento\Framework\Filter\Template::filter --');
+                        $logger->info('-- before executing $directiveProcessor->process() --');
+                        $logger->info('template value: ' . $value);
+                        $logger->info('-- executing $directiveProcessor->process() --');
+                    }
                     $replacedValue = $directiveProcessor->process($construction, $this, $this->templateVars);

                     $value = str_replace($construction[0], $replacedValue, $value);
--
2.34.1

