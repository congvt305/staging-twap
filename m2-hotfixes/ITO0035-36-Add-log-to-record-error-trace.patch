From 1c6d66bea2f55977c37e99f22bef998c008d1cda Mon Sep 17 00:00:00 2001
From: Hoang Phan <hoangphan@amorepacific.com>
Date: Thu, 16 Mar 2023 12:00:13 +0700
Subject: [PATCH] ITO0035-36 Update log to trace issue PDOException(code:
 23000)

---
 vendor/magento/framework/DB/Statement/Pdo/Mysql.php | 23 ++++++++++++++++++++---
 1 file changed, 20 insertions(+), 3 deletions(-)

diff --git a/vendor/magento/framework/DB/Statement/Pdo/Mysql.php b/vendor/magento/framework/DB/Statement/Pdo/Mysql.php
index d24bc5f..5e170c7 100644
--- a/vendor/magento/framework/DB/Statement/Pdo/Mysql.php
+++ b/vendor/magento/framework/DB/Statement/Pdo/Mysql.php
@@ -87,9 +87,26 @@ class Mysql extends \Zend_Db_Statement_Pdo
         if ($specialExecute) {
             return $this->_executeWithBinding($params);
         } else {
-            return $this->tryExecute(function () use ($params) {
-                return $params !== null ? $this->_stmt->execute($params) : $this->_stmt->execute();
-            });
+            try {
+                return $this->tryExecute(function () use ($params) {
+                    return !empty($params) ? $this->_stmt->execute($params) : $this->_stmt->execute();
+                });
+            } catch (\Zend_Db_Statement_Exception $e) {
+                if ($e->getCode() == '23000') {
+                    $errorMsg = 'PDOException(code: 23000): with params: ' . json_encode($params) . ' and back trace: ';
+                    $writer = new \Zend_Log_Writer_Stream(BP . '/var/log/log-for-ticket-ITO0035-36-a-foreign-key-constraint-fails.log');
+                    $logger = new \Zend_Log();
+                    $logger->addWriter($writer);
+                    $debugBackTrace = debug_backtrace(DEBUG_BACKTRACE_IGNORE_ARGS);
+                    $backTrace = '';
+                    foreach ($debugBackTrace as $item) {
+                        $backTrace .= @$item['class'] . ':' . @$item['line'] . @$item['type'] . @$item['function'] . " | ";
+                    }
+                    $logger->crit($errorMsg . $backTrace);
+                    $logger->info('message: ' . $e->getMessage());
+                }
+                throw $e;
+            }
         }
     }

--
2.34.1

