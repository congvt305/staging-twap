From c458d43e55952b174f02a80561f5008b4a6a3b07 Mon Sep 17 00:00:00 2001
From: Hoang Phan <hoangphan@amorepacific.com>
Date: Thu, 9 Mar 2023 11:51:54 +0700
Subject: [PATCH] ITO0016-140 Cron Tasks List error check
 request_magento_scheduled_import_export_log_clean

---
 vendor/magento/framework/Filesystem/Directory/Write.php              | 11 +++++++++++
 vendor/magento/module-scheduled-import-export/Cron/ScheduledLogClean.php                        |  4 ++++
 2 files changed, 15 insertions(+)

diff --git a/vendor/magento/framework/Filesystem/Directory/Write.php b/vendor/magento/framework/Filesystem/Directory/Write.php
index e455eaf..4d04d1e 100644
--- a/vendor/magento/framework/Filesystem/Directory/Write.php
+++ b/vendor/magento/framework/Filesystem/Directory/Write.php
@@ -204,11 +204,13 @@ class Write extends Read implements WriteInterface
             try {
                 $this->deleteFilesRecursively($absolutePath);
             } catch (FileSystemException $e) {
+                $this->_logError('deleteFilesRecursively', $e, $absolutePath);
                 $exceptionMessages[] = $e->getMessage();
             }
             try {
                 $this->driver->deleteDirectory($absolutePath);
             } catch (FileSystemException $e) {
+                $this->_logError('deleteDirectory', $e, $absolutePath);
                 $exceptionMessages[] = $e->getMessage();
             }

@@ -243,6 +245,7 @@ class Write extends Read implements WriteInterface
                     $this->validatePath($entityPath);
                     $this->driver->deleteFile($entityPath);
                 } catch (FileSystemException | ValidatorException $e) {
+                    $this->_logError('deleteFile', $e, $entityPath);
                     $exceptionMessages[] = $e->getMessage();
                 }
             }
@@ -383,4 +386,12 @@ class Write extends Read implements WriteInterface
     {
         return $this->driver;
     }
+
+    private function _logError($fn, $e, $path)
+    {
+        $writer = new \Zend_Log_Writer_Stream(BP . '/var/log/log-for-ticket-ITO0016-140-Cron-Tasks-List-error-check.log');
+        $logger = new \Zend_Log();
+        $logger->addWriter($writer);
+        $logger->crit("An exception occurred while running function " . $fn . ", " . json_encode(['path' => $path, 'exception' => $e->getMessage()]));
+    }
 }
diff --git a/vendor/magento/module-scheduled-import-export/Cron/ScheduledLogClean.php b/vendor/magento/module-scheduled-import-export/Cron/ScheduledLogClean.php
index 8600646..3d335c5 100644
--- a/vendor/magento/module-scheduled-import-export/Cron/ScheduledLogClean.php
+++ b/vendor/magento/module-scheduled-import-export/Cron/ScheduledLogClean.php
@@ -142,6 +142,10 @@ class ScheduledLogClean
                     try {
                         $this->_logDirectory->delete($directory);
                     } catch (FileSystemException $e) {
+                        $writer = new \Zend_Log_Writer_Stream(BP . '/var/log/log-for-ticket-ITO0016-140-Cron-Tasks-List-error-check.log');
+                        $logger = new \Zend_Log();
+                        $logger->addWriter($writer);
+                        $logger->crit('exception "' . $e->getMessage() . '" occurred when deleting directory "' . $directory . '"');
                         throw new \Magento\Framework\Exception\LocalizedException(
                             __('We can\'t delete "%1" because the directory is not writable.', $directory)
                         );
--
2.34.1

